---
sidebar_position: 2
title: Set up server
hide_title: false
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## Setting up a data node

To setup a data node, you must have followed the guide to setup and install a Vega node.

A data node must be run in conjunction with a Vega node. The Vega node will send the events it receives from the network and the events it creates to the data node, which will then store them in a database. An API is provided to query the data stored by the data node.

The database used by the data node is a Postgresql database with the Timescale extension installed. The database can be a dedicated database server, a docker container, or an embedded version of Postgresql with Timescale installed that is provided by Vega.

:::Note: The following instructions assume you are installing on a Ubuntu Linux machine as explained in the [server setup guide](setup-server.md).

### Pre-requisites

#### Vega core

Please following instructions in the [server setup guide](setup-server.md) to install Vega.

#### Postgresql and TimescaleDB full installation

We have tested and recommend using version 2.8.0 of the TimescaleDB plugin with Postgres 14. The installation instructions can be found in [Timescales Documentation](https://docs.timescale.com/install/latest/self-hosted/installation-debian/).

To ensure you install the correct version of TimescaleDB, you can use the following command, as detailed in the notes at the bottom of the `Installing self-hosted TimescaleDB on Debian-based systems`:

```Shell
apt-get install timescaledb-2-postgresql-14='2.8.0*' timescaledb-2-loader-postgresql-14='2.8.0*'
```

##### Adding a role and database for the data node

1. If the a user does not already exist for the database, you will need to create one.

    ```Shell
    sudo adduser <database_user>
    ```

    Follow the prompts to create the user and set a password.

2. Create a new role in postgres for your database user

    ```shell
    sudo -u postgres createuser --interactive
    ```

    Follow the prompts to create the role for your database user.

3. Create a new database for the database user

    ```shell
    sudo -u postgres createdb <database_name>
    ```

    Follow the prompts to create the database for your database user.

#### Postgresql and TimescaleDB docker installation

If you prefer to run Postgresql and TimescaleDB in a docker container, you can use the following command to start a Postgresql docker container with TimescaleDB installed:

:::note This guide assumes you already have Docker installed on your system. For full installation guide consult Docker's [documentation](https://docs.docker.com/engine/install/ubuntu/).
:::

```Shell
docker run -d \
    --rm \
    --name data-node-db \
    -e POSTGRES_USER=<database_user> \
    -e POSTGRES_PASSWORD=<database_password> \
    -e POSTGRES_DB=<database_name> \
    -p <localdb_port>:5432
    -v /host_path/to/snapshotsCopyTo:/snapshotsCopyTo:z \
    -v /host_path/to/snapshotsCopyFrom:/snapshotsCopyFrom:z \
    timescale/timescaledb:2.8.0-pg14
```

Where:

- `database_user` is the user name you want to use to connect to the database.
- `database_password` is the password you want to use to connect to the database.
- `database_name` is the name of the database you want to use for storing the data.
- `localdb_port` is the port you want to use to connect to the database on your local machine. (5432 is the default port for Postgresql database server and may not be available if you already have a postgresql database server running on your machine and want to use Docker for testing).
- `/host_path/to/snapshotsCopyTo` is the path on your host machine where you want to store the snapshots that are generated by data-node. Snapshots allow you to restore the database to a previous state.
- `/host_path/to/snapshotsCopyFrom` is the path on your host machine where you want to store the snapshots that are retrieved from IPFS and can be used to rebuild a data-node database from another data-node.

### Generating configuration files

#### Vega and Tendermint configuration

Before you can use vega, you need to generate the default configuration files for Vega and Tendermint. You can then alter those to the specific requirements.

The below command will create home paths (if they don't already exist) and generate the configuration in the paths you chose.

```shell
vega init --home=YOUR_VEGA_HOME_PATH --tendermint-home=YOUR_TENDERMINT_HOME_PATH [NODE_MODE]
```

Where `NODE_MODE` can be:

- `validator` if you are setting up a validator node (default), or
- `full` if you are setting up a non-validator node

To update your node configuration, such as to set up ports for the APIs, edit the config file:

```shell
YOUR_VEGA_HOME_PATH/config/node/config.toml
```

:::note For more information about setting up a validator node, see the [validator node setup guide](setup-validator.md).
:::

#### Data Node configuration

To generate the configuration files you need for the data node, you can use the following command:

```shell
vega data-node init --home=YOUR_DATA_NODE_HOME_PATH
```

To update your data node configuration, such as to set up ports for the APIs or database credentials etc., edit the config file:

```shell
YOUR_DATA_NODE_HOME_PATH/config/data-node/config.toml
```

### Configuration

#### Vega

To configure your Vega node to work with a data-node you need to update the `[Broker.Socket]` section of the Vega configuration file `YOUR_VEGA_HOME_PATH/config/node/config.toml` from:

```toml
  [Broker.Socket]
    DialTimeout = "2m0s"
    DialRetryInterval = "5s"
    SocketQueueTimeout = "3s"
    EventChannelBufferSize = 10000000
    SocketChannelBufferSize = 1000000
    MaxSendTimeouts = 10
    Address = "127.0.0.1"
    Port = 3005
    Enabled = false
    Transport = "tcp"
```

to:

```toml
  [Broker.Socket]
    ...
    Enabled = true
    ...
```

:::note While it's possible to run the data node and Vega node on separate machines, it's not recommended given the volume of
data that will be transferred between the two.
:::

#### Data Node

##### Database configuration

Data node database configuration is defined under the `[SQLStore.ConnectionConfig]` section of the data node configuration file `YOUR_DATA_NODE_HOME_PATH/config/data-node/config.toml`:

```toml
  [SQLStore.ConnectionConfig]
    Host = "localhost"
    Port = 5432
    Username = "vega"
    Password = "vega"
    Database = "vega"
    MaxConnLifetime = "30m0s"
    MaxConnLifetimeJitter = "5m0s"
```

You should ensure the database configuration matches those of the database you created in the pre-requisite steps.

##### Wipe On Startup

If you want to wipe the database on startup, you can set the `WipeOnStartup` flag to `true` in the data node configuration file `YOUR_DATA_NODE_HOME_PATH/config/data-node/config.toml`:

```toml
[SQLStore]
  WipeOnStartup = true
```

:::warning This will wipe the database on startup, so use with caution.

Once the database has been wiped, data-node will reconstruct the database tables and will allow you to repopulate the data from the network chain, however this can take a long time depending on the size of the chain.
:::

##### Embedded Postgres

If you do not have access to. or do not want to use a Postgresql database server, or a Postgres Docker container, it is possible to run a data node with an embedded version of Postgres. You can enable this by setting the flag:

```toml
[SQLStore]
  ...
  UseEmbedded = true
  ...
```

This will cause data node to download a specially prepared Postgresql package which is extracted to your local machine if it doesn't exist. A separate Postgresql process will be spawned by data node using the credentials you specified in the database configuration section. Once data node is stopped, the child Postgresql process will be stopped automatically.

##### Buffered event source

When a data-node is restarted from snapshots, it is possible for the event queue to become flooded causing the Vega core to panic when the event queue is full and stop both the Vega core and data node.

To prevent this, you can enable the buffered event source by setting the flag:

```toml
[Broker]
  ...
  UseBufferedEventSource = true
  ...
```

### Running Vega and Data Node

It is recommended to start the data node before starting the Vega node. By default if the `Broker.Socket.Enabled` flag is set to true, the Vega node will attempt to connect to the data node on startup. It will continue to try and connect for one minute before giving up.

To start the data node, run the following command:

```shell
vega data-node start --home=YOUR_DATA_NODE_HOME_PATH
```

To start Vega, run the following command:

```shell
vega start --home=YOUR_VEGA_HOME_PATH --tendermint-home=YOUR_TENDERMINT_HOME_PATH
```
