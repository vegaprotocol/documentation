---
sidebar_position: 3
title: Validator node
hide_title: false
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

This section will take your through all the steps to configure your node as a validator and join an existing network.

:::note
All the following command will use an optional --home flag. This flag allow to specify a custom home for the configuration, state, cache, of your vega node. The flag is not mandatory and a default path will be chosen if not specified (the XDG Base Directory standard is use to create the path, see: [XDG Base Directory spec](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html).
:::
:::info
You can list all the path used by your vega installation by using the following command:
```
vega paths list
```
:::

## Generate the configurations

We start by generating a vega validator node configuration, you will be asked for a passphrase for your nodewallet (if writing automation you may want to use --nodewallet-passphrase-file option which allow you to specify a file containing the passphrase, make sure to save this passphrase as it allow to unlock the nodewallet:
```
vega init --home="path/to/home/root" validator
```

This command should output the path of the main configuration file, feel free to open and change setting if needed (we'll go through setting up a couple mandatory setting later).

Then generate the tendermint node configuration, for convenience the vega toolchain also embed tendermint, you can run all tendermint subcommand using this vega command:
```
vega tm
```
We will generate the configuration using the following command:
```
vega tm --home="path/to/tendermint/home/root" init
```

## Setup the nodewallet
Each validator node require a few cryptographic wallets to operate properly:
- Ethereumn wallet: this will be used to sign transaction going through the ERC20 bridge
- Vega wallet this will be used to sign transaction sent by validators in the vega network
The public key of the tendermint node needs to be saved in the nodewallet as well. All these
informations need to be check in properly before starting the node, when the network starts or a node is added to the validator set these information will be checked against the transaction used to register the node on the network, any incorrect setup will stop the node from joining the network.

:::note
For the following nodewallet command you will be prompted to input your nodewallet passphrase (that you created when initialised vega). If you cannot run these command interactively you can specify a file containing the passphrase using the following flag: `--passphrase-file=`.
:::

### Tendermint public key
To save the tendermint public key in your nodewallet use the following command:
```
vega nodewallet import --chain=tendermint --home=path/to/home --tendermint-pubkey="YOUR_TENDERMINT_PUBKEY"
```

If you are using the keys generated by tendermint, you can find the public key at the following path: `path/to/tendermint/config/priv_validator_key.json`, if you're tendermint node is set up to use tmkns, then refer to the [documentation](https://github.com/iqlusioninc/tmkms) to get your public key.

:::note
If you are not using tmkms (e.g: the default software keys generated by tendermint, you could run the following command instead:
```
vega nodewallet import --chain=tendermint --home=path/to/home --tendermint-home=path/to/tendermint
```
This will read the tendermint keys from the configuration path, and setup your nodewallet properly.
:::

### Ethereum wallet
Vega support two types of ethereum wallet, you can either register a wallet available from a clef instance or import a keystore file (e.g: create with `geth account`).

#### Using clef
To setup your clef instance please refer to the [clef documentation](https://geth.ethereum.org/docs/clef/tutorial).

First set the address of  your clef instance in the vega configuration (`path/to/home/config/node/config.toml`):
```Toml
[NodeWallet]
  Level = "Info"
  [NodeWallet.ETH]
    Level = "Info"
    Address = ""
    ClefAddress = "http://your.clef.instance.network:3334"
```

:::note
Alternatively you can run the following command and specify the flag: `--eth.clef-address="http://your.clef.instance.network:3334"`
:::

Then run the following command:
```
vega nodewallet import --chain=ethereum --home=path/to/home --clef-account-address="0xYOUR_WALLET_ADDRESS"
```

#### Using a keystore account file
You can either import an existing keystore (see how to create them [using geth](https://geth.ethereum.org/docs/getting-started)) using the following command:
```
vega nodewallet import --chain=ethereum --home="path/to/home" --wallet-passphrase-file="file/containing/account/passphrase" --wallet-path="path/to/wallet"
```

Or use the following command to create a new one and save it in the nodewallet:
```
vega nodewallet generate --chain=ethereum --home="path/to/home" --wallet-passphrase-file="file/containing/account/passphrase"
```

#### Vega wallet

We recommend you use an isolated key, for information on how to isolate vega wallet keys see [here](../tools/vega-wallet/cli-wallet/latest/guides/isolate-keys.md):
```
vega nodewallet import --chain=vega --home="path/to/home" --wallet-passphrase-file="file/containing/account/passphrase" --wallet-path="path/to/wallet"
```

Alternatively you can also create a new wallet and save it in the nodewallet:
```
vega nodewallet generate --chain=vega --home="path/to/home" --wallet-passphrase-file="file/containing/account/passphrase"
```

:::info
You can verify the informations save in your nodewallet using the following command:
```
vega nodewallet show
```
:::

### Configure the ethereum node address
Each vega validator node needs to be connected to an ethereum node. This allow the node to verify that event happened on ethereum (e.g: a deposit or a withdrawal).
Set the ethereum node address in the vega configuration (`path/to/home/config/node/config.toml`):
```Toml
[NodeWallet]
  Level = "Info"
  [NodeWallet.ETH]
    Level = "Info"
    Address = "http://ethereum.node.com/rpc"
    ClefAddress = ""
```


### Join a network

In order to join a network the public keys of your validator need to be included in a Genesis file. The Gensis files for public Vega networks are maintained in the [vegaprotocol/networks](https://github.com/vegaprotocol/networks) repository. If you want to join a network at the next restart you will need to generate your validator config to be added to a genesis file. Alternatively you can create a new network by creating a genesis file.

#### Create a new network
A new network can be create using the following command:
```
vega genesis generate --home="path/to/home" --tm-home="path/to/tendermint"
 ```
This will generate a new genesis file with a single validator (using informations setup in the nodewallet) and all default network parameters.

:::warning
This command will overwrite any genesis file in your tendermint config (path/to/tendermint/config/genesis.json). If you want just want to see the output of the command without commiting to the change use the --dry-run flag.
:::


#### Add validators information in an existing genesis file
If you are willing to join another network with an existing genesis file, you can use the following command to generate your validator node information to be added in the genesis file of the network you want to join:
```
vega genesis new validator --home="path/to/home" \
    --country="YOUR_COUNTRY" \
	--info-url="http://your.website.com" \
	--info-url="YOUR_NODE_NAME" \
	--avatar-url="YOUR_AVATAR_URL" \
```

This should print a json payload similar to:
```
Info to add in genesis file under `validators` key
{
  "address": "B0CAF4EC9AAC7C256733E09471AC16700F973222",
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "plmxJSjg5IC7r8yLWBQUFFTosvXC+rTpbXgf0kCoqoY="
  },
  "power": "10",
  "name": "yournode"
}
Info to add in genesis file under `app_state.validators` key
{
    "plmxJSjg5IC7r8yLWBQUFFTosvXC+rTpbXgf0kCoqoY=": {
      "id": "1e19e3373816089539c37b040e93a3f73696cced6051cf1e0f1dea739762aac7",
      "vega_pub_key": "60be34a837b825b10762db8436e95c39e4ddef22c5dd5f3153064aecf9868c12",
      "vega_pub_key_index": 1,
      "ethereum_address": "0x3560700a09515695975D719679892C0B111C5332",
      "tm_pub_key": "plmxJSjg5IC7r8yLWBQUFFTosvXC+rTpbXgf0kCoqoY=",
      "info_url": "https://your.node.com",
      "country": "FR",
      "name": "yournode",
      "avatar_url": "https://your.node.com/avatar",
      "from_epoch": 0
    }
  }
```

Then add both section in the appropriates places in the genesis file.
